<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Transcript & Summary</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>
                {% if meetingType == 'zoom' %}
                ğŸ“¹ Zoom Meeting - Transcript & Summary
                {% else %}
                ğŸ’¬ Teams Meeting - Transcript & Summary
                {% endif %}
            </h1>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="window.history.back()">â† Back</button>
                <a href="/" class="btn btn-secondary">ğŸ  Home</a>
                {% if user %}
                <span style="margin-left: 10px; font-size: 0.9em; color: #666;">
                    ğŸ‘¤ {{ user.name or user.email }}
                </span>
                {% endif %}
            </div>
        </header>
        
        <main>
            {% if error %}
            <div class="card">
                <div class="error">{{ error }}</div>
                <button class="btn btn-primary" onclick="window.history.back()">â† Back</button>
            </div>
            {% elif message %}
            <div class="card">
                <div class="success">{{ message }}</div>
            </div>
            {% endif %}
            
            {% if transcript %}
            <div class="card">
                <h2>Original Transcript</h2>
                <div class="transcript-box">
                    <pre>{{ transcript }}</pre>
                </div>
            </div>
            {% endif %}

            {% if summary %}
            <div class="card">
                <h2>AI-Generated Summary</h2>
                <div class="summary-box">
                    <div id="summaryDisplay" class="summary-display">{{ summary|safe }}</div>
                    <textarea id="summaryEdit" class="summary-edit" style="display: none;">{{ summary }}</textarea>
                </div>
                
                <div class="button-group">
                    <button id="editBtn" class="btn btn-primary" onclick="toggleEdit()">
                        âœï¸ Edit Summary
                    </button>
                    <button id="saveBtn" class="btn btn-success" onclick="saveEdit()" style="display: none;">
                        ğŸ’¾ Save Changes
                    </button>
                    <button id="cancelBtn" class="btn btn-secondary" onclick="cancelEdit()" style="display: none;">
                        âŒ Cancel
                    </button>
                    
                    {% if meetingType == 'teams' %}
                    {% if authenticated %}
                    <button type="button" class="btn btn-teams" onclick="sendToTeams()">
                        ğŸ“¤ Send in Teams
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-teams" onclick="loginToSend()">
                        ğŸ” Login to Post in Teams
                    </button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <script>
        let currentSummary = {{ summary|tojson|safe if summary else '""' }};
        let isEditing = false;

        function toggleEdit() {
            if (!isEditing) {
                isEditing = true;
                document.getElementById('summaryDisplay').style.display = 'none';
                document.getElementById('summaryEdit').style.display = 'block';
                document.getElementById('summaryEdit').value = currentSummary;
                
                document.getElementById('editBtn').style.display = 'none';
                document.getElementById('saveBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'inline-block';
            }
        }

        function saveEdit() {
            currentSummary = document.getElementById('summaryEdit').value;
            document.getElementById('summaryDisplay').innerHTML = currentSummary;
            
            isEditing = false;
            document.getElementById('summaryDisplay').style.display = 'block';
            document.getElementById('summaryEdit').style.display = 'none';
            
            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';

            alert('Summary saved successfully!');
        }

        function cancelEdit() {
            isEditing = false;
            document.getElementById('summaryDisplay').style.display = 'block';
            document.getElementById('summaryEdit').style.display = 'none';
            
            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        function loginToSend() {
            const meetingId = '{{ meeting_id or "" }}';
            const meetingType = '{{ meetingType or "" }}';
            const loginUrl = `/auth/login?return_type=${meetingType}&return_id=${meetingId}`;
            
            // For simplicity and to avoid session issues with popups, always redirect in same window
            // This ensures the session cookie is properly set and recognized
            window.location.href = loginUrl;
        }

        function sendToTeams() {
            if (!confirm('Send this summary to all meeting participants via Teams?')) {
                return;
            }

            fetch('/teams/send-summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    meeting_id: '{{ meeting_id or "" }}',
                    summary: currentSummary,
                    participants: {{ (participants|tojson|safe) if participants else "[]" }}
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… Summary sent successfully to Teams!');
                    // Optionally reload to update UI
                    // window.location.reload();
                } else if (data.error && data.error.includes('Not authenticated')) {
                    alert('âš ï¸ Your session has expired. Please log in again.');
                    loginToSend();
                } else {
                    alert('âŒ Failed to send summary: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('âŒ Error sending summary: ' + error.message);
            });
        }
    </script>
</body>
</html>
