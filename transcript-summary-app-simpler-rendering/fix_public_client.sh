#!/bin/bash

echo "ğŸ” Diagnosing 'Client is public' Error"
echo "========================================"
echo ""

echo "This error means Azure thinks your app is a PUBLIC client,"
echo "but your code is using it as a CONFIDENTIAL client (with secret)."
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "CRITICAL: Check Azure Portal Settings"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Go to: Azure Portal â†’ Azure AD â†’ App registrations â†’ Your App"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "STEP 1: Check Redirect URIs (You've done this)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Click: Authentication (left menu)"
echo ""
echo "Under 'Platform configurations':"
echo "  âœ… Web"
echo "     â””â”€ http://localhost:5001/auth/callback"
echo ""
echo "  âš ï¸  If you also see 'Mobile and desktop applications':"
echo "     You can leave it OR remove the redirect URI from there"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "STEP 2: Disable Public Client Flows (CRITICAL!)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Scroll down on the same 'Authentication' page to:"
echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Advanced settings                                       â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚ Allow public client flows                              â”‚"
echo "â”‚ Enable the following mobile and desktop flows:         â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚ âš ï¸  CURRENT (causing error):                            â”‚"
echo "â”‚     â— Yes  â† WRONG FOR SERVER APPS                     â”‚"
echo "â”‚     â—‹ No                                                â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚ âœ… MUST CHANGE TO:                                      â”‚"
echo "â”‚     â—‹ Yes                                               â”‚"
echo "â”‚     â— No   â† SELECT THIS FOR SERVER APPS               â”‚"
echo "â”‚                                                         â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "Then click: [Save]"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "STEP 3: Verify Client Secret Exists"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Click: Certificates & secrets (left menu)"
echo ""
echo "Under 'Client secrets' tab:"
echo "  âœ… Should have at least one active (not expired) secret"
echo ""
echo "  If NOT, or if expired:"
echo "    1. Click: + New client secret"
echo "    2. Description: 'Production Secret'"
echo "    3. Expires: Choose duration (24 months recommended)"
echo "    4. Click: Add"
echo "    5. âš ï¸  COPY THE VALUE IMMEDIATELY (won't show again!)"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "STEP 4: Update .env with Secret VALUE (not ID)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "In your .env file, make sure you have the secret VALUE:"
echo ""
echo "MICROSOFT_CLIENT_SECRET=ABC~defGHI123jklMNO456~pqrSTU789"
echo "                         â†‘"
echo "                         This should be ~40 characters"
echo "                         with special chars like ~ or ."
echo ""
echo "âŒ WRONG (this is the secret ID, not VALUE):"
echo "   MICROSOFT_CLIENT_SECRET=12345678-1234-1234-1234-123456789abc"
echo ""
echo "âœ… CORRECT (this is the secret VALUE):"
echo "   MICROSOFT_CLIENT_SECRET=abc~123.DEF456ghi~789JKL"
echo ""

# Check current .env
if [ -f .env ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "YOUR CURRENT .env CONFIGURATION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    SECRET=$(grep "^MICROSOFT_CLIENT_SECRET=" .env 2>/dev/null | cut -d '=' -f2- | tr -d '"' | tr -d "'")
    
    if [ -z "$SECRET" ]; then
        echo "âŒ MICROSOFT_CLIENT_SECRET: NOT SET"
        echo "   You must add this to your .env file!"
    else
        SECRET_LEN=${#SECRET}
        echo "âœ… MICROSOFT_CLIENT_SECRET: Set (length: $SECRET_LEN chars)"
        echo "   First 10 chars: ${SECRET:0:10}..."
        echo ""
        
        if [ $SECRET_LEN -lt 30 ]; then
            echo "âš ï¸  WARNING: Secret seems too short ($SECRET_LEN chars)"
            echo "   Typical secret is 40+ characters"
            echo "   You might have the secret ID instead of VALUE"
        elif echo "$SECRET" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
            echo "âŒ ERROR: This looks like a GUID/UUID (secret ID)"
            echo "   You need the secret VALUE, not the ID!"
            echo "   Go to Azure Portal â†’ Certificates & secrets"
            echo "   Create a NEW secret and copy the VALUE"
        else
            echo "âœ… Secret format looks correct (has special chars, right length)"
        fi
    fi
    echo ""
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "STEP 5: Restart App"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "After making changes:"
echo ""
echo "  ./start_fresh.sh"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "STEP 6: Test Configuration"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Check if app is running with correct config:"
echo ""
echo "  curl http://localhost:5001/debug/msal-config | python3 -m json.tool"
echo ""
echo "Should show:"
echo "  - client_secret_set: true"
echo "  - client_secret_length: 40+ "
echo ""

if curl -s http://localhost:5001/debug/msal-config > /dev/null 2>&1; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "CURRENT APP CONFIGURATION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    curl -s http://localhost:5001/debug/msal-config | python3 -m json.tool
    echo ""
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "SUMMARY: What You Need to Do"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Azure Portal changes:"
echo "  1. âœ… Authentication â†’ Platform: Web (you did this)"
echo "  2. âš ï¸  Authentication â†’ Advanced settings â†’ Allow public client flows: NO"
echo "  3. âœ… Certificates & secrets â†’ Ensure you have active secret"
echo ""
echo ".env file changes:"
echo "  1. âš ï¸  MICROSOFT_CLIENT_SECRET must be the VALUE (40+ chars with special chars)"
echo "  2. âš ï¸  NOT the secret ID (GUID format)"
echo ""
echo "After changes:"
echo "  ./start_fresh.sh"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
